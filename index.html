<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Local Terrain | ArcGIS Maps SDK for JavaScript</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-width: 350px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        #info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        #info code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status.online {
            background: #4caf50;
        }

        .status.offline {
            background: #f44336;
        }

        .status.loading {
            background: #ff9800;
        }
    </style>

    <link href="https://js.arcgis.com/4.34/esri/themes/light/main.css" rel="stylesheet" type="text/css" />
    <script src="https://js.arcgis.com/4.34/"></script>

    <script>
        require([
            "esri/layers/ElevationLayer",
            "esri/Ground",
            "esri/Map",
            "esri/views/SceneView", "esri/layers/WebTileLayer", "esri/config",
            "esri/layers/VectorTileLayer",
        ], (ElevationLayer, Ground, Map, SceneView, WebTileLayer, esriConfig, VectorTileLayer) => {


            esriConfig.log.level = "none";


         
            const localElevationLayer = new ElevationLayer({
                // This URL points to the Node.js wrapper server
                url: "http://localhost:3001/arcgis/rest/services/LocalTerrain3D/ImageServer",

                // Optional: Set custom tile info if needed
                // tileSize: 256
            });

            const PakMapMix = new WebTileLayer({
                // urlTemplate: "http://localhost:5566/tiles//pakistan1-13x/{level}/{col}/{row}",
                urlTemplate: "https://mt1.google.com/vt/lyrs=s&x={col}&y={row}&z={level}",
                subDomains: ["a"],
                title: "PakMapx",
                opacity: 1,
            });
   
            // Create ground with local elevation
            const localGround = new Ground({
                layers: [localElevationLayer],
                navigationConstraint: {
                    type: "stay-above"
                },
                opacity: 1
            });

            // Create map with local terrain
            const map = new Map({
                basemap: {
                    baseMapLayers: [
                        {
                            "id": "VectorTile_3708",
                            "type": "VectorTileLayer",
                            "layerType": "VectorTileLayer",
                            "title": "Newspaper",
                            "styleUrl": "https://www.arcgis.com/sharing/rest/content/items/dfb04de5f3144a80bc3f9f336228d24a/resources/styles/root.json",
                            "itemId": "dfb04de5f3144a80bc3f9f336228d24a",
                            "visibility": true,
                            "opacity": 1
                        }
                    ],
                    title: "Newspaper"
                },
                ground: localGround  // Use local terrain instead of "world-elevation"
            });

            map.add(PakMapMix);
            // Islamabad coordinates (from your original code)
            //33.77932500302994, 72.94201260476956
            const initCamera = {
                heading: 0,
                tilt: 60,
                position: {
                    latitude: 33.77932500302994,
                    longitude: 72.94201260476956,
                    z: 3990
                }
            };

            const view = new SceneView({
                container: "viewDiv",
                map: map,
                camera: initCamera,

                // Optional: Configure viewing mode
                viewingMode: "global",

                // Highlight options
                highlightOptions: {
                    fillOpacity: 0.5
                },
                background: {
                    type: "color",
                    color: [0, 0, 0, 255],
                },
                alphaCompositingEnabled: true,
            });

            view.ui.components = []; //remove all UI components : required for MFD
            view.environment = {
                background: {
                    type: "color",
                    color: [0, 0, 0, 255],
                },
                atmosphereEnabled: true,
                lighting: {
                    directShadowsEnabled: true,
                    ambientOcclusionEnabled: false,
                },

                starsEnabled: true,
            };
            // Monitor terrain loading
            let statusEl = null;

            view.when(() => {
                console.log("SceneView initialized");

                // Check if elevation layer is loading
                localElevationLayer.when(() => {
                    console.log("Elevation layer loaded successfully");
                    updateStatus("online", "Local terrain loaded");
                }).catch((error) => {
                    console.error("Elevation layer failed:", error);
                    updateStatus("offline", "Terrain load failed: " + error.message);
                });

            }).catch((error) => {
                console.error("SceneView failed:", error);
            });

            function updateStatus(status, message) {
                if (statusEl) {
                    statusEl.className = "status " + status;
                    statusEl.nextElementSibling.textContent = message;
                }
            }

            // Create status indicator after DOM ready
            view.ui.add(document.getElementById("info"), "manual");


        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
    <div id="info">
        <h3>üó∫Ô∏è Local Terrain Demo</h3>
        <p>This demonstrates loading locally hosted terrain tiles instead of ArcGIS online.</p>
        <p>
            <span class="status loading" id="status-indicator"></span>
            <span id="status-text">Loading terrain...</span>
        </p>
        <hr style="margin: 10px 0; border-color: #ddd;">
        <p><strong>Tile Server:</strong><br><code>localhost:5566</code></p>
        <p><strong>API Wrapper:</strong><br><code>localhost:3001</code></p>
    </div>
</body>

</html>